@*
 * Copyright 2018 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import sdil.models.ReturnsVariation
@import sdil.models.SdilReturn
@import sdil.models.backend.Subscription
@import sdil.models.retrieved.RetrievedSubscription

@(key: String, lineItems: List[(String, (Long, Long), Int)], costLower: BigDecimal, costHigher: BigDecimal, subtotal: BigDecimal, broughtForward: BigDecimal, total: BigDecimal, variation: Option[ReturnsVariation] = None, subscription: RetrievedSubscription, originalReturn: Option[SdilReturn])(implicit m: Messages)

@formatMoney(value: BigDecimal) = {
    @if(value < 0) {
        @{f"-£${value.abs}%,.2f"}
    } else {
        @{f"£$value%,.2f"}
    }
}

<table class="check-your-answers">
    <caption class="heading-medium">@Messages(s"$key.balance.due", formatMoney(total))</caption>
    <thead>
        <tr>
            <th>@Messages(s"$key.activity")</th>
            <th>@Messages(s"$key.band")</th>
            <th>@Messages(s"$key.litres")</th>
            <th>@Messages(s"$key.cost")</th>
            <th></th>
        </tr>
    </thead>

    <tbody>
        @for((lineKey, litres, multiplier) <- lineItems) {
            <tr>
                <td rowspan="2">@Messages(s"$key.$lineKey")</td>
                <td>@Messages(s"$key.low")</td>
                <td>@{f"${litres._1}%,d"}</td>
                <td class="no-minus-wrapping">@formatMoney(costLower * litres._1 * multiplier)</td>
                <td>
                    <a href="@lineKey" class="returns-change-link">
                        @Messages(s"$key.change") <span class="visuallyhidden">@Messages(s"$key.change.$lineKey")</span>
                    </a>
                </td>
            </tr>
            <tr>
                <td>@Messages(s"$key.high")</td>
                <td>@{f"${litres._2}%,d"}</td>
                <td class="no-minus-wrapping"> @formatMoney(costHigher * litres._2 * multiplier)</td>
                <td>
                    <a href="@lineKey" class="returns-change-link">
                        @Messages(s"$key.change") <span class="visuallyhidden">@Messages(s"$key.change.$lineKey")</span>
                    </a>
                </td>
            </tr>
        }
        @*Insert subtotal and amount brought forward back in Q2 filing*@
        @*<tr>*@
            @*<th scope="row" colspan="3"><h4 class="heading-small">@Messages(s"$key.subtotal")</h4></th>*@
            @*<td class="numeric"><h4 class="heading-small no-minus-wrapping">@formatMoney(subtotal)</h4></td>*@
            @*<td></td>*@
        @*</tr>*@
        @*<tr>*@
            @*<th scope="row" colspan="3"><h4 class="heading-small">@Messages(s"$key.balance.brought.forward")</h4></th>*@
            @*<td class="numeric"><h4 class="heading-small no-minus-wrapping">@formatMoney(broughtForward)</h4></td>*@
            @*<td></td>*@
        @*</tr>*@
        @if(originalReturn.nonEmpty) {
            @originalReturn.map { r =>
                <tr>
                    <td scope="row" colspan="3">@Messages(s"$key.total.original")</td>
                    <td class="numeric">@formatMoney(r.total)</td>
                    <td></td>
                </tr>
                @if(r.total != total) {
                    <tr>
                        <td scope="row" colspan="3">@Messages(s"$key.total.new")</td>
                        <td class="numeric">@formatMoney(total)</td>
                        <td></td>
                    </tr>
                    <tr>
                        @if((total - r.total) < 0) {
                            <td scope="row" colspan="3"><h4 class="heading-small">@Messages(s"$key.net.adjusted.negative")</h4></td>
                        } else {
                            <td scope="row" colspan="3"><h4 class="heading-small">@Messages(s"$key.net.adjusted.positive")</h4></td>

                        }
                        <td class="numeric"><h4 class="heading-small no-minus-wrapping">@formatMoney(total - r.total)</h4></td>
                        <td></td>
                    </tr>
                }
            }

        } else {
            <tr>
                <th scope="row" colspan="3"><h4 class="heading-small">@Messages(s"$key.total")</h4></th>
                <td class="numeric"><h4 class="heading-small no-minus-wrapping">@formatMoney(total)</h4></td>
                <td></td>
            </tr>
        }
    </tbody>
</table>


@originalReturn.map { r =>
    @if((total - r.total) > 0) {
        <br/>
        <div class="panel panel-border-wide form-group">
            <p>
                You may be charged interest on your net adjusted amount after correcting an error. We will let you know
                if interest is due and how much you need to pay. Find out what happens
                <a href="https://www.gov.uk/guidance/submit-a-return-and-pay-the-soft-drinks-industry-levy-notice-2" target="_blank">
                    if you owe more levy (opens in a new window or tab).</a>

            </p>
        </div>
    } else {
        <br/><br/>
    }
}

    @variation.map { variation =>

        @if(variation.packingSites.nonEmpty) {

            <table class="check-your-answers">
                <caption class="heading-medium">@Messages("variations.cya.packsites.add")</caption>

                <thead>
                    <tr>
                        <th class="cya-width">
                            <h2 class="heading-small">
                            @Messages("variations.cya.packsites.address")
                            </h2>
                        </th>
                        <th>
                            <h2 class="heading-small">
                            @Messages("variations.cya.postcode")
                            </h2>
                        </th>
                        <th>
                        </th>
                    </tr>
                </thead>

                <tbody>
                @for(site <- variation.packingSites) {
                    <tr>
                        <td>
                            <details role="group">
                                <summary role="button" aria-controls="details-content-1" aria-expanded="false">
                                    <span class="summary">@site.address.lines.head</span>
                                </summary>
                                @for(line <- site.address.lines.tail) {
                                    <div aria-hidden="true">@line</div>
                                }
                                <div class="postal-code">@site.address.postCode</div>
                            </details>
                        </td>
                        <td>@site.address.postCode</td>
                        <td class="change-answer">
                            <a href="production-sites">
                            @Html(Messages("variations.cya.packsites.change"))
                            </a>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        }

        @if(variation.warehouses.nonEmpty) {
            <table class="check-your-answers">
                <caption class="heading-medium">@Messages("variations.cya.warehouses.add")</caption>

                <thead>
                    <tr>
                        <th class="cya-width">
                            <h2 class="heading-small">
                            @Messages("variations.cya.warehouses")
                            </h2>
                        </th>
                        <th>
                            <h2 class="heading-small">
                            @Messages("variations.cya.postcode")
                            </h2>
                        </th>
                        <th>
                        </th>
                    </tr>
                </thead>

                <tbody>
                @for(site <- variation.warehouses) {
                    <tr>
                        <td>
                            <details role="group">
                                <summary role="button" aria-controls="details-content-1" aria-expanded="false">
                                    <span class="summary">
                                    @site.getLines.head
                                    </span>
                                </summary>
                                @for(line <- site.getLines.tail.dropRight(1)) {
                                    <div aria-hidden="true">@line</div>
                                }
                                <div class="postal-code">@site.address.postCode</div>
                            </details>
                        </td>
                        <td>@site.address.postCode</td>
                        <td class="change-answer">
                            <a href="secondary-warehouses">
                            @Html(Messages("variations.cya.warehouses.change"))
                            </a>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        }

        @if(variation.importer._1 || variation.packer._1) {
            <h3 class="heading-medium">@Messages(s"$key.variations.subheading")</h3>
        }

        @if(variation.importer._1 && subscription.warehouseSites.isEmpty && variation.warehouses.nonEmpty) {
            <p>@Html(Messages("check-your-answers.variations.import-with-warehouses-some"))</p>
        }

        @if(variation.importer._1 && subscription.warehouseSites.isEmpty && variation.warehouses.isEmpty) {
            <p>@Html(Messages("check-your-answers.variations.import-with-warehouses-empty"))</p>
        }

        @if(variation.importer._1 && subscription.warehouseSites.nonEmpty) {
            <p>@Messages("check-your-answers.variations.import-without-warehouses")</p>
        }

        @if(variation.packer._1 && subscription.productionSites.isEmpty) {
            <p>@Html(Messages("check-your-answers.variations.import-with-packSites"))</p>
        }

        @if(variation.packer._1 && subscription.productionSites.nonEmpty) {
            <p>@Html(Messages("check-your-answers.variations.import-without-packSites"))</p>
        }
    }

@if(originalReturn.isEmpty) {
    <h3 class="heading-medium">@Messages(s"$key.submit-subheading")</h3>
    <p>@Messages(s"$key.submit-paragraph")</p>
}

<p>
    <a href="javascript:window.print()" class="print-link" onclick="ga('send', 'event', 'print', 'click', 'Print')">
        @Messages("sdil.common.print")
    </a>
</p>
